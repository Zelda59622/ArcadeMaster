<script src="base.js"></script>
    <script src="auth.js"></script>
    <script>
        // --- LOGIQUE DE LA BOUTIQUE (JS) ---

        // DonnÃ©es des skins (inchangÃ©es)
        const SKINS_DATA = {
            spaceInvaders: {
                ship: [
                    { id: 100, name: "Classique", symbol: "ðŸš€", price: 0, category: 'ship' },
                    { id: 101, name: "Aigle", symbol: "ðŸ¦…", price: 50, category: 'ship' },
                    { id: 102, name: "VipÃ¨re", symbol: "ðŸ", price: 150, category: 'ship' },
                    { id: 103, name: "Soucoupe", symbol: "ðŸ›¸", price: 500, category: 'ship' },
                ],
                invader: [
                    { id: 200, name: "Classique", symbol: "ðŸ‘¾", price: 0, category: 'invader' },
                    { id: 201, name: "Yeux Rouges", symbol: "ðŸ‘¹", price: 100, category: 'invader' },
                    { id: 202, name: "Robot Jaune", symbol: "ðŸ¤–", price: 300, category: 'invader' },
                ]
            },
            snakeInfini: {
                snake_head: [
                    { id: 300, name: "TÃªte Verte", symbol: "ðŸŸ¢", price: 0, category: 'snake_head' },
                    { id: 301, name: "TÃªte Bleue", symbol: "ðŸ”µ", price: 50, category: 'snake_head' },
                    { id: 302, name: "TÃªte Flamme", symbol: "ðŸ”¥", price: 200, category: 'snake_head' },
                ],
                food: [
                    { id: 400, name: "Pomme", symbol: "ðŸŽ", price: 0, category: 'food' },
                    { id: 401, name: "Diamant", symbol: "ðŸ’Ž", price: 100, category: 'food' },
                    { id: 402, name: "GÃ¢teau", symbol: "ðŸŽ‚", price: 400, category: 'food' },
                ]
            }
        };
        
        // Fonction utilitaire pour obtenir la liste des skins possÃ©dÃ©s (uniquement si connectÃ©)
        function getOwnedSkins(category) {
            const user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
            if (user && user.id !== 0 && user.skins && user.skins.owned && user.skins.owned[category]) {
                return user.skins.owned[category];
            }
            return []; // Retourne vide si dÃ©connectÃ©
        }


        // CORRECTION: Logique d'achat (Mode ConnectÃ© ForcÃ©)
        window.buySkin = function(game, category, skinId, price) {
            const skin = SKINS_DATA[game][category].find(s => s.id === skinId);
            const user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;

            if (!user || user.id === 0) { 
                 alert("Achat impossible : Veuillez vous connecter Ã  votre compte !");
                 return;
            } 
            
             // --- LOGIQUE POUR UTILISATEUR CONNECTÃ‰ ---
             if (user.coins >= price) {
                  user.coins -= price; // 1. RETIRER LES PIÃˆCES
                  
                  // 2. AJOUTER LE SKIN Ã€ LA LISTE DES SKINS POSSÃ‰DÃ‰S
                  if (!user.skins.owned) user.skins.owned = {};
                  if (!user.skins.owned[category]) {
                      user.skins.owned[category] = [];
                  }
                  user.skins.owned[category].push(skinId);

                  // 3. Ã‰QUIPER LE NOUVEAU SKIN AUTOMATIQUEMENT
                  if (!user.skins.active) user.skins.active = {};
                  user.skins.active[category] = skin.symbol;
                  
                  // 4. SAUVEGARDER L'UTILISATEUR GLOBALEMENT
                  if (typeof updateGlobalUser === 'function') {
                      updateGlobalUser(user);
                  }
                  if (typeof updateTopBar === 'function') {
                      updateTopBar(); // Mettre Ã  jour l'affichage des piÃ¨ces
                  }

                  alert(`ACHAT ET Ã‰QUIPEMENT RÃ‰USSIS ! Le skin ${skin.name} est Ã  vous. ${price} piÃ¨ces retirÃ©es.`);
                  
                  renderAllSkins(true); 

             } else {
                  alert(`Achat impossible : Il vous manque ${price - user.coins} piÃ¨ces !`);
             }
        }
        
        // CORRECTION: Logique d'Ã©quipement (Mode ConnectÃ© ForcÃ©)
        window.equipSkin = function(game, category, skinId, symbol) {
            const user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
            
            if (!user || user.id === 0) { 
                 alert("Ã‰quipement impossible : Veuillez vous connecter Ã  votre compte !");
                 return;
            } 

             // Mise Ã  jour de l'utilisateur connectÃ©
             if (!user.skins.active) user.skins.active = {};
             user.skins.active[category] = symbol;

             if (typeof updateGlobalUser === 'function') {
                updateGlobalUser(user);
             }
             if (typeof updateTopBar === 'function') {
                updateTopBar(); 
             }

            alert(`Skin Ã©quipÃ© : ${symbol}`);
            renderAllSkins(true); 
        }
        
        // Rend le bouton HTML
        function createButton(skin, game, category) {
             // VÃ©rifier si connectÃ© est nÃ©cessaire pour l'affichage du bouton
             const user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
             const isConnected = user && user.id !== 0;
             
             // Si l'utilisateur est dÃ©connectÃ©, afficher seulement le prix
             if (!isConnected) {
                 const span = document.createElement('span');
                 span.className = 'btn-secondary';
                 span.textContent = `${skin.price} ðŸ’°`;
                 return span;
             }
             
             // Logique pour les connectÃ©s (achat ou Ã©quipement)
             const isOwned = getOwnedSkins(category).includes(skin.id);

             if (isOwned) {
                const equipBtn = document.createElement('button');
                equipBtn.className = 'btn-primary';
                
                // Mettre "Ã‰quipÃ©" si le skin est actif
                const isActive = user.skins.active[category] === skin.symbol;
                equipBtn.textContent = isActive ? 'Ã‰quipÃ© âœ”ï¸' : 'Ã‰quiper';
                
                equipBtn.style.backgroundColor = isActive ? 'var(--color-neon-orange)' : 'var(--color-neon-green)';
                equipBtn.disabled = isActive;
                equipBtn.onclick = () => equipSkin(game, category, skin.id, skin.symbol);
                return equipBtn;
             } else {
                const buyBtn = document.createElement('button');
                buyBtn.className = 'btn-primary';
                buyBtn.textContent = `Acheter (${skin.price} ðŸ’°)`;
                buyBtn.style.backgroundColor = 'var(--color-neon-blue)';
                buyBtn.onclick = () => buySkin(game, category, skin.id, skin.price);
                return buyBtn;
             }
        }
        
        // GÃ©nÃ¨re le HTML pour une sous-catÃ©gorie (inchangÃ©e)
        function renderSubCategory(containerId, game, categoryKey, categoryTitle) {
            // ... (logique de rendu inchangÃ©e) ...
        }
        
        // CORRECTION: Fonction de rendu principale avec vÃ©rification de connexion
        window.renderAllSkins = function(reRender = false) {
            const user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
            const isConnected = user && user.id !== 0;

            const restrictedContent = document.getElementById('restrictedShopContent');
            const loginPrompt = document.getElementById('loginPrompt');
            
            if (!restrictedContent || !loginPrompt) return;

            if (isConnected) {
                restrictedContent.style.display = 'block';
                loginPrompt.style.display = 'none';

                if (reRender) {
                     document.getElementById('spaceInvadersSkins').innerHTML = '';
                     document.getElementById('snakeSkins').innerHTML = '';
                }
                
                renderSubCategory('spaceInvadersSkins', 'spaceInvaders', 'ship', 'Vaisseaux ðŸš€');
                renderSubCategory('spaceInvadersSkins', 'spaceInvaders', 'invader', 'Monstres ðŸ‘¾');

                renderSubCategory('snakeSkins', 'snakeInfini', 'snake_head', 'TÃªtes de Serpent ðŸ');
                renderSubCategory('snakeSkins', 'snakeInfini', 'food', 'Nourriture ðŸŽ');
                
            } else {
                // S'assurer que le contenu est masquÃ© et le prompt affichÃ©
                restrictedContent.style.display = 'none';
                loginPrompt.style.display = 'block';
                // Rendu des achats de piÃ¨ces (si non masquÃ© par CSS global)
                document.getElementById('coinPacks').style.display = 'flex'; 
            }
        }

        // GÃ¨re l'achat des piÃ¨ces (Rickroll)
        window.buyCoins = function(pack) {
            alert(`Vous avez tentÃ© d'acheter le ${pack}. La transaction est en cours...`);
            window.location.href = "https://www.youtube.com/watch?v=dQw4w9WgXcQ"; 
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof updateTopBar === 'function') {
                updateTopBar();
            }
            renderAllSkins(); 
        });
    </script>
